/* ===================================================
 * ZL Framework
 * https://zoolanders.com/extensions/zl-framework
 * ===================================================
 * Copyright (C) JOOlanders SL
 * http://www.gnu.org/licenses/gpl-2.0.html GNU/GPLv2 only
 * ========================================================== */
!function(a,b,c,d){"use strict";var e=function(){};a.extend(e.prototype,a.zlux.Manager.prototype,{name:"filesManager",options:{root:"images",extensions:"",storage:"local",storage_params:{},max_file_size:"",resize:{}},initialize:function(b,c){this.options=a.extend({},this.options,c);var d=this;d.initCheck(),d.target=b,d.filesmanager=a('<div class="zl-bootstrap zlux-filesmanager" />').appendTo(b),d.initDataTable(d.filesmanager)},initCheck:function(){var b=this;a.zlux.filesManager.iNextUnique++,b.ID=a.zlux.filesManager.iNextUnique,a.zlux.filesManager.instances[b.ID]=b,b.options.max_file_size=b.parseSize(b.options.max_file_size),b.options.extensions=b.options.extensions.replace(/\|/g,","),(""===b.options.storage||b.options.storage===d||null===b.options.storage)&&(b._ErrorLog(0,b._("STORAGE_PARAM_MISSING")),b.options.storage="local"),b.sStartRoot=b.cleanPath(b.options.root),b.sCurrentPath=b.sStartRoot},initDataTable:function(b){var c=this;a.zlux.assets.load(a.zlux.url.zlfw("zlux/assets/datatables/dataTables.with.plugins.min.js"),function(){c._initDataTable(b)})},_initDataTable:function(b){var c=this;a('<table cellpadding="0" cellspacing="0" border="0" class="table table-striped table-bordered" />').appendTo(b),c.oTable=a("table",b).dataTable({sDom:"F<'row-fluid'<'span12't>>",oLanguage:{sEmptyTable:c._("EMPTY_FOLDER"),sInfoEmpty:""},sAjaxUrl:a.zlux.url.ajax("zlux"),sAjaxSource:a.zlux.url.ajax("zlux","getFilesManagerData"),sServerMethod:"POST",bPaginate:!1,aoColumns:[{sTitle:"",mData:"type",bSearchable:!1,sWidth:"14px",sClass:"column-icon",mRender:function(a,b){return"display"===b?'<i class="icon-'+("folder"===a?"folder-close":"file-alt")+'"></i>':a}},{sTitle:c._("NAME"),mData:"name",sClass:"column-name",mRender:function(a,b){return"display"===b?"":a},fnCreatedCell:function(b,d,e){a(b).parent("tr").attr("data-id",c.cleanPath(e.name))}}],aoColumnDefs:{bVisible:!1,aTargets:[2]},aaSorting:[[0,"desc"],[1,"asc"]],fnServerData:function(a,b,d,e){c._fnServerData(a,b,d,e)},fnServerParams:function(a){a.push({name:"extensions",value:c.options.extensions}),"s3"===c.options.storage&&(a.push({name:"storage",value:"s3"}),a.push({name:"accesskey",value:c.options.storage_params.accesskey}),a.push({name:"key",value:c.options.storage_params.secretkey}),a.push({name:"bucket",value:c.options.storage_params.bucket}))},fnRowCallback:function(b,d){var e=d;e.dom=a(b),e.dom.attr("data-type",d.type).addClass("zlux-object"),a(".column-name",e.dom).html("").removeClass("zlux-ui-open").append(c.renderObjectDOM(e)),a(".zlux-x-name",e.dom).append('<i class="zlux-x-name-edit icon-edit-sign" title="'+c._("RENAME")+'" />')},fnInitComplete:function(){var d=a(".zlux-x-filter-input_wrapper",b).append(a('<i class="icon-search" />'),a('<i class="icon-remove zlux-ui-dropdown-unselect" />').hide().on("click",function(){a("input",d).val(""),a(this).hide(),c.oTable.fnFilter("")}));a("input",d).on("keyup",function(){""===a(this).val()?a(".zlux-ui-dropdown-unselect",d).hide():a(".zlux-ui-dropdown-unselect",d).show()}),setTimeout(function(){c.trigger("InitComplete")},50)},fnPreDrawCallback:function(){c.zluxdialog.spinner("show")},fnDrawCallback:function(b){var d=b.oInstance.fnPagingInfo(),e=a(".dataTables_paginate",a(b.nTableWrapper)).closest(".row-fluid");d.iTotalPages<=1?e.hide():e.show(),c.trigger("DrawCallback"),c.zluxdialog.scrollbar("refresh"),c.zluxdialog.spinner("hide")}}).on("click",".zlux-object .zlux-x-name a",function(){var b=a(this).closest("tr.zlux-object"),d=c.oTable.fnGetData(b[0]);return d.dom=b,"true"!==d.dom.attr("data-zlux-object-status")&&(d.dom.attr("data-zlux-object-status","true"),d.dom.siblings().removeAttr("data-zlux-object-status"),"folder"===d.dom.data("type")&&(c.oTable.fnSettings(),c.sGoToPath=d.dom.data("id"),c.oTable.fnReloadAjax()),c.trigger("ObjectSelected",d)),!1}).on("click",".zlux-object .zlux-x-remove",function(){var b=a(this).closest("tr.zlux-object"),d=a("td",b),e=c.oTable.fnGetData(b[0]);return e.dom=b,d.hasClass("zlux-ui-open")&&c.trigger("BeforeDeleteFile",e),!1})},_fnServerData:function(b,c,d,e){var f,g=this;f=g.cleanPath(g.sCurrentPath+"/"+g.sGoToPath),g.sGoToPath="",c.push({name:"root",value:f}),e.jqXHR=a.ajax({url:b,data:c,beforeSend:function(){var b=!1;if(!g.bReloading||g.bRedrawing){var c=a.zlux.filesManager.aAjaxDataCache[f];if(c&&(g.bCacheInited||(g.sStartRoot=c.root),g.sCurrentPath=f,g.bCacheInited=!0,a(e.oInstance).trigger("xhr",[e,c]),d(c),b=!0),g.bRedrawing)return g.bRedrawing=!1,g.sCurrentPath=f,!1}return b?!1:void g.zluxdialog.spinner("show")},dataType:"json",cache:!1,type:e.sServerMethod,error:function(a,b){"parsererror"===b&&e.oApi._fnLog(e,0,"DataTables warning: JSON data from server could not be parsed. This is caused by a JSON formatting error.")}}).done(function(b){b.errors.length&&e.oApi._fnLog(e,0,b.errors),b=b.result,g.bCacheInited||(g.sStartRoot=b.root),g.sCurrentPath=b.root,g.bReloading&&(a.zlux.filesManager.aAjaxDataCache={}),a.zlux.filesManager.aAjaxDataCache[b.root]=b,g.redrawInstances(),g.bReloading=!1,g.bCacheInited=!0,a(e.oInstance).trigger("xhr",[e,b]),d(b)})},reload:function(){var a=this;a.bReloading=!0,a.oTable.fnReloadAjax()},redrawInstances:function(){var b=this;a.each(a.zlux.filesManager.instances,function(a,c){return parseInt(a)===b.ID?!0:void(c.oTable&&(c.bRedrawing=!0,c.oTable.fnReloadAjax()))})},initBreadcrumb:function(){var b=this;b.breadcrumb=a('<ul class="breadcrumb" />').prependTo(b.filesmanager).wrap('<div class="row-fluid"><div class="span12" /></div>').on("click","a",function(){return b.sCurrentPath=b.sStartRoot,b.sGoToPath=a(this).data("path"),b.oTable.fnReloadAjax(),!1}),b.bind("DrawCallback initBreadcrumb",function(){var c,d=b.sCurrentPath?b.sCurrentPath:"",e=[],f=b._("ROOT").toLowerCase();d=d.replace(new RegExp("^"+b.sStartRoot),""),d=d.replace(/(^\/|\/$)/,""),c=d.length?d.split("/"):[],e.push(c.length?'<li><a href="#" data-path="">'+f+'</a><span class="divider">/</span></li>':'<li class="active">'+f+"</li>"),d=[],a.each(c,function(a,b){d.push(b),e.push(c.length===a+1?'<li class="active">'+b.toLowerCase()+"</li>":'<li><a href="#" data-path="'+d.join("/")+'">'+b.toLowerCase()+'</a><span class="divider">/</span></li>')}),b.breadcrumb.html(e.join(""))}).trigger("initBreadcrumb")},renderObjectDOM:function(b){var c,d=this;c="folder"===b.type?[{name:d._("NAME"),value:b.basename}]:[{name:d._("NAME"),value:b.basename},{name:d._("TYPE"),value:b.content_type},{name:d._("SIZE"),value:b.size.display}];var e="";a.each(c,function(a,b){e+="<li><strong>"+b.name+"</strong>: <span>"+b.value+"</span></li>"});var f=a('<div class="zlux-x-tools"><i class="zlux-x-details-btn icon-angle-down" /><i class="zlux-x-remove icon-minus-sign" title="'+d._("DELETE")+'" /></div><div class="zlux-x-name"><a href="#" class="zlux-x-name-link">'+b.name+'</a></div><div class="zlux-x-details"><div class="zlux-x-messages" /><div class="zlux-x-details-content"><ul class="unstyled">'+e+"</ul></div></div>");return f},deleteObject:function(b){var c=this,d=[],e=c.getFullPath(b.name);return d=c.pushStorageData(d),"s3"===c.options.storage&&"folder"===b.type&&(e+="/"),d.push({name:"path",value:e}),a.Deferred(function(b){a.ajax({url:a.zlux.url.ajax("zlux","deleteObject"),data:d,dataType:"json",type:"post"}).done(function(a){a.result?(b.resolve(),c.trigger("FileDeleted",e)):b.reject(a.errors)}).fail(function(){b.reject(c._("SOMETHING_WENT_WRONG"))})}).promise()},createFolder:function(b){var c=this,d=[],e=c.getFullPath(b);return d=c.pushStorageData(d),"s3"===c.options.storage&&(e+="/"),d.push({name:"path",value:e}),a.Deferred(function(b){a.ajax({url:a.zlux.url.ajax("zlux","newFolder"),data:d,dataType:"json",type:"post"}).done(function(a){a.result?b.resolve(a.name):b.reject(a.errors)}).fail(function(){b.reject(c._("SOMETHING_WENT_WRONG"))})}).promise()},renameObject:function(b){var c=this,d=a(".zlux-x-name a",b.dom),e=d.html().match(/\.+[a-zA-Z]+$/g),f=d.html().replace(/\.+[a-zA-Z]+$/g,"");e=null!==e?e:"";var g=a("<div>"+c._("INPUT_THE_NEW_NAME")+'<br /><input class="zlux-x-input" type="text" value="'+f+'" /> '+e+'<br /><span class="label label-success label-link">'+c._("CONFIRM").toLowerCase()+"</span></div>").on("click",".label-link",function(){a(this).data("submited")||(a(this).data("submited",!0),a(".column-icon i",b.dom).addClass("icon-spinner icon-spin"),c._changeObjectName(b,a("input",g).val()+e).done(function(e){d.html(e),a(".zlux-x-details-content ul li:first span",b.dom).html(e),b.dom.attr("data-id",e),b.name=e,b.basename=e.replace(/\.+[a-zA-Z]+$/g,""),b.path=b.path.replace(/(\w|[-.])+$/,e),a.zlux.filesManager.aAjaxDataCache[c.sCurrentPath].aaData=c.oTable.fnGetData(),c.redrawInstances(),b.dom.removeAttr("data-zlux-object-status"),a(".zlux-x-msg",b.dom).remove()}).fail(function(a){c.pushMessageToObject(b,a)}).always(function(){a(".column-icon i",b.dom).removeClass("icon-spinner icon-spin")}))}).on("keypress","input",function(b){var c=b.keyCode?b.keyCode:b.which;13===c&&a(".label-link",g).trigger("click")});c.pushMessageToObject(b,g)},_changeObjectName:function(b,c){var d=this,e=[],f=d.getFullPath(b.name),g=d.getFullPath(c);return e=d.pushStorageData(e),"s3"===d.options.storage&&"folder"===b.type&&(f+="/",g+="/"),e.push({name:"src",value:f}),e.push({name:"dest",value:g}),a.Deferred(function(b){a.ajax({url:a.zlux.url.ajax("zlux","moveObject"),data:e,dataType:"json",type:"post"}).done(function(a){a.result?b.resolve(a.name):b.reject(a.errors)}).fail(function(){b.reject(d._("SOMETHING_WENT_WRONG"))})}).promise()},getFullPath:function(a){var b=this.sCurrentPath;return b?b+"/"+a:a},_getRowFromPath:function(b){var c=this;return a('tr[data-path="'+b+'"]',c.oTable)},parseSize:function(a){if("string"!=typeof a||""===a)return a;var b,c={t:1099511627776,g:1073741824,m:1048576,k:1024};return a=/^([0-9]+)([mgk]?)$/.exec(a.toLowerCase().replace(/[^0-9mkg]/g,"")),b=a[2],a=+a[1],c.hasOwnProperty(b)&&(a*=c[b]),a},pushStorageData:function(a){var b=this;return"s3"===b.options.storage&&(a.push({name:"storage",value:"s3"}),a.push({name:"accesskey",value:b.options.storage_params.accesskey}),a.push({name:"key",value:b.options.storage_params.secretkey}),a.push({name:"bucket",value:b.options.storage_params.bucket})),a}}),a.zlux[e.prototype.name]=e,a.zlux[e.prototype.name].iNextUnique=0,a.zlux[e.prototype.name].aAjaxDataCache={},a.zlux[e.prototype.name].instances={}}(jQuery,window,document),function(a,b,c,d){"use strict";var e=function(b,c){var d=this,f=a(b);f.data(e.prototype.name)||(d.element=a(b),d.options=a.extend({},e.prototype.options,a.zlux.filesManager.prototype.options,c),this.events={},d.initialize(),d.element.data(e.prototype.name,d))};a.extend(e.prototype,a.zlux.filesManager.prototype,{name:"filesDialogManager",options:{title:"Files Manager",full_mode:0,dialogClass:""},initialize:function(){var a=this;a.initCheck(),a.element.on("click",function(){return a.zluxdialog.toggle(),!1}),a.initDialog(),a.initMainEvents()},initDialog:function(){var b=this;b.options.dialogClass="zl-bootstrap zlux-filesmanager"+(b.options.full_mode?" zlux-dialog-full ":"")+(b.options.dialogClass?" "+b.options.dialogClass:""),a.zlux.assets.load("dialog").done(function(){b.zluxdialog=a.zlux.dialog({title:b.options.title,width:b.options.full_mode?"75%":300,dialogClass:b.options.dialogClass,position:b.options.full_mode===!1?{of:b.element,my:"left top",at:"right bottom"}:null}).bind("InitComplete",function(){b.zluxdialog.widget.attr("id","zluxFilesManager_"+b.ID),b.eventDialogLoaded()})})},eventDialogLoaded:function(){var b=this;b.filesmanager=a('<div class="zlux-filesmanager" />').appendTo(b.zluxdialog.content),b.initDataTable(b.filesmanager),b.zluxdialog.main.on("click",".zlux-x-details-btn",function(){var c=a(this),d=c.closest("tr.zlux-object"),e=a("td.column-name",d),f=a(".zlux-x-details",d);e.hasClass("zlux-ui-open")?(c.addClass("icon-angle-down").removeClass("icon-angle-up"),e.removeClass("zlux-ui-open"),f.slideUp("fast",function(){b.zluxdialog.scrollbar("refresh")})):(e.addClass("zlux-ui-open"),c.removeClass("icon-angle-down").addClass("icon-angle-up"),b.zluxdialog.content.stop().animate({scrollTop:d.get(0).offsetTop},900,"swing"),f.slideDown("fast",function(){b.zluxdialog.scrollbar("refresh")}))}),b.zluxdialog.main.on("click",".icon-edit-sign",function(){var c,d=a(this).closest("tr.zlux-object");c=b.oTable.fnGetData(d[0]),c.dom=d,b.renameObject(c)}),a("html").on("mousedown",function(a){!b.zluxdialog.dialog("isOpen")||b.element.is(a.target)||b.element.find(a.target).length||b.zluxdialog.widget.find(a.target).length||b.zluxdialog.dialog("close")}),b.initMainToolbar(),b.zluxdialog.newSubToolbar("filter","main"),b.zluxdialog.newSubToolbar("newfolder","main"),b.initUploader()},initMainEvents:function(){var b=this;b.bind("InitComplete",function(){b.zluxdialog.scrollbar("refresh");var c=a(".zlux-dialog-subtoolbar-filter",b.zluxdialog.toolbar.wrapper);a(".zlux-x-filter-input_wrapper",b.oTable.fnSettings().nTableWrapper).appendTo(c),b.initBreadcrumb(),b.zluxdialog.initContent()}).bind("BeforeDeleteFile",function(c,d){if(!a(".zlux-x-details-message-actions")[0]){var e="folder"===d.type?"DELETE_THIS_FOLDER":"DELETE_THIS_FILE",f=a("<div>"+b._(e)+'<span class="label label-warning label-link">'+b._("CONFIRM").toLowerCase()+"</span></div>").on("click",".label-link",function(){if(!a(this).data("submited")){a(this).data("submited",!0),a(".column-icon i",d.dom).addClass("icon-spinner icon-spin");var c=b.deleteObject(d);c.done(function(){d.dom.fadeOut("slow",function(){a(this).remove();var c=a.zlux.filesManager.aAjaxDataCache[b.sCurrentPath].aaData;a.each(c,function(a,b){return d.dom.data("id")===b.name&&d.dom.data("type")===b.type?(c.splice(a,1),!1):void 0}),b.redrawInstances()})}).fail(function(a){b.pushMessageToObject(d,a)}).always(function(){a(".column-icon i",d.dom).removeClass("icon-spinner icon-spin")})}});b.pushMessageToObject(d,f)}})},initMainToolbar:function(){var b=this;b.zluxdialog.setMainToolbar([{title:b._("APPLY_FILTERS"),icon:"filter",click:function(a){b.zluxdialog.toggleSubtoolbar("filter","main"),a.parent().siblings().children("i").not(a).removeClass("zlux-ui-tool-enabled"),a.toggleClass("zlux-ui-tool-enabled")}},{title:b._("NEW_FOLDER"),icon:"folder-close",subicon:"plus-sign",click:function(c){b.zluxdialog.toggleSubtoolbar("newfolder","main"),a(".zlux-dialog-subtoolbar-newfolder",b.zluxdialog.toolbar.wrapper).html("").append(a('<input type="text" class="zlux-x-input" placeholder="'+b._("FOLDER_NAME")+'" />').on("keypress",function(c){var d=c.keyCode?c.keyCode:c.which;13===d&&(b.createFolder(a(this).val()),b.zluxdialog.spinner("show"),b.createFolder(a(this).val()).always(function(){b.reload()}))})),c.parent().siblings().children("i").not(c).removeClass("zlux-ui-tool-enabled"),c.toggleClass("zlux-ui-tool-enabled")}},{title:b._("UPLOAD_FILES"),icon:"cloud-upload",click:function(){b.zluxdialog.showToolbar(2),b.zluxdialog.scrollbar("hide"),a(".zlux-filesmanager",b.zluxdialog.content).fadeOut("400",function(){b.zluxupload.inited||b.zluxupload.init(),b.zluxupload.options.path=b.sCurrentPath,a(".zlux-upload",b.zluxdialog.content).fadeIn("400")})}},{title:b._("REFRESH"),icon:"refresh",click:function(){b.reload()}}])},initUploader:function(){var b=this;b.zluxdialog.newToolbar([{title:b._("ADD_NEW_FILES"),icon:"plus-sign",id:"add",click:function(){}},{title:b._("START_UPLOADING"),icon:"upload disabled",id:"start",click:function(){return b.zluxupload.uploader.start(),!1}},{title:b._("CANCEL_CURRENT_UPLOAD"),icon:"ban-circle disabled",id:"cancel",click:function(){b.zluxupload.uploader.stop(),b.zluxdialog.toolbarBtnState(2,"ban-circle","disabled"),b.zluxdialog.toolbarBtnState(2,"upload","enabled"),b.zluxdialog.toolbarBtnState(2,"plus-sign","enabled")}}],2,function(){a(".zlux-upload",b.zluxdialog.content).fadeOut("400",function(){b.zluxupload.emptyQueue(),a(".zlux-filesmanager",b.zluxdialog.content).fadeIn("400"),b.zluxupload._updateFilelist(),b.zluxdialog.scrollbar("refresh")})}),b.zluxupload=a.zlux.filesUpload({path:"images",wrapper:b.zluxdialog.content,storage:b.options.storage,storage_params:b.options.storage_params,max_file_size:b.options.max_file_size,extensions:b.options.extensions,browse_button:a('.zlux-dialog-toolbar-2 i[data-id="add"]',b.zluxdialog.toolbar.wrapper),resize:b.options.resize}).bind("QueueChanged",function(){b.zluxdialog.scrollbar("refresh")}).bind("FilesAdded",function(c,e){b.zluxdialog.toolbarBtnState(2,"upload","enabled"),c.filelist.show(),a.each(e,function(e,f){f.status="validating";var g={name:f.name,basename:f.name.replace(/(\.[a-z0-9]+)$/,""),type:"file",content_type:f.type,size:{size:f.size,display:plupload.formatSize(f.size)}};if(g.dom=a('<tr id="'+f.id+'" class="zlux-object" data-zlux-status="validating" />').append(a('<td class="column-icon" />').append('<i class="icon-file-alt zlux-x-object-icon" />'),a('<td class="column-name" />').append(b.renderObjectDOM(g))).appendTo(c.filelist),a(".zlux-x-tools",g.dom).append(a('<span class="zlux-upload-file-progress"/>')),a(".zlux-x-name",g.dom).html(f.name),f.size!==d&&""!==b.options.max_file_size&&f.size>b.options.max_file_size){a(".icon-file-alt",g.dom).removeClass("icon-file-alt").addClass("icon-warning-sign");var h=b.pushMessageToObject(g,b.sprintf(b._("FILE_SIZE_ERROR"),plupload.formatSize(b.options.max_file_size)));return a(".zlux-x-msg-remove",h).remove(),!0}a.ajax({url:a.zlux.url.ajax("zlux","validateObjectName"),type:"post",data:{name:f.name},dataType:"json",cache:!1,beforeSend:function(){a(".column-icon i",g.dom).addClass("icon-spinner icon-spin")},success:function(b){a(".zlux-x-name",g.dom).html(b.result),f.name=b.result,f.status=1,c._handleFileStatus(f),a(".column-icon i",g.dom).removeClass("icon-spinner icon-spin"),c._updateFilelist()}})})}).bind("BeforeUpload",function(){b.zluxdialog.toolbarBtnState(2,"cancel","enabled"),b.zluxdialog.toolbarBtnState(2,"start","disabled"),b.zluxdialog.toolbarBtnState(2,"add","disabled")}).bind("FileUploaded",function(c,d){a(".zlux-x-name",d.dom).html(d.name),a(".zlux-upload-file-progress",d.dom).html("100%").fadeOut(),a(".zlux-x-object-icon",d.dom).removeClass("icon-file-alt").addClass("icon-ok"),a(".zlux-x-name",d.dom).wrapInner('<a class="zlux-x-name-link" href="#" />').end().on("click","a",function(){if(b.zluxdialog.spinning)return!1;var c=a('.zlux-object[data-id="'+d.name+'"]',b.filesmanager);return d=b.oTable.fnGetData(c[0]),b.trigger("ObjectSelected",d),!1})}).bind("FileNotUpload",function(c,d,e){b.zluxdialog.toolbarBtnState(2,"cancel","disabled"),b.zluxdialog.toolbarBtnState(2,"start","disabled"),b.zluxdialog.toolbarBtnState(2,"add","enabled"),a(".zlux-upload-file-progress",d.dom).fadeOut(),a(".zlux-x-object-icon",d.dom).removeClass("icon-file-alt").addClass("icon-warning-sign");var f=b.pushMessageToObject(d,e);a(".zlux-x-msg-remove",f).remove()}).bind("UploadComplete",function(){b.zluxdialog.toolbarBtnState(2,"cancel","disabled"),b.zluxdialog.toolbarBtnState(2,"start","disabled"),b.zluxdialog.toolbarBtnState(2,"add","enabled"),b.reload()}).bind("CancelUpload",function(){b.zluxdialog.toolbarBtnState(2,"cancel","disabled"),b.zluxdialog.toolbarBtnState(2,"add","enabled")}).bind("QueueChanged",function(c,d){var e=!1;a.each(d,function(a,b){b.status!==plupload.DONE&&"validating"!==b.status&&(e=!0)}),d.length&&e?b.zluxdialog.toolbarBtnState(2,"start","enabled"):b.zluxdialog.toolbarBtnState(2,"start","disabled")}).bind("FileError",function(c,d,e){if(b.uploading&&"pending"===b.uploading.state())return void b.uploading.reject(e);d.dom[0]||(d.dom=a('<tr id="'+d.id+'" class="zlux-object" />').append(a('<td class="column-icon" />').append('<i class="icon-file-alt zlux-x-object-icon" />'),a('<td class="column-name" />').append(b.renderObjectDOM(d))).appendTo(c.filelist),c._updateFilelist()),a(".zlux-x-object-icon",d.dom).removeClass("icon-file-alt").addClass("icon-warning-sign");var f=b.pushMessageToObject(d,e);a(".zlux-x-msg-remove",f).remove()})}}),a.zlux[e.prototype.name]=e}(jQuery,window,document),function(a,b,c,d){"use strict";var e=function(b){this.options=a.extend({},this.options,b),this.events={}};a.extend(e.prototype,a.zlux.Main.prototype,{name:"filesUpload",options:{extensions:"",path:null,fileMode:"files",max_file_size:"1024kb",wrapper:null,storage:"local",storage_params:{},browse_button:null,resize:{}},init:function(){var b=this;b.upload=a('<div class="zlux-upload" />').attr("data-zlux-status","").appendTo(b.options.wrapper).hide(),b.dropzone=a('<div class="zlux-upload-dropzone" />').appendTo(b.upload).append(a('<span class="zlux-upload-dropzone-msg" />')),b.initDnDevents(),b.bind("WindowDragHoverStart",function(){b.dropzone.attr("data-zlux-draghover",!0)}),b.bind("WindowDragHoverEnd",function(){b.dropzone.attr("data-zlux-draghover",!1)}),b.initFilelist(),a.zlux.assets.load(a.zlux.url.zlfw("zlux/assets/plupload/plupload.full.min.js"),function(){b.initPlupload(),b.bind("Init",function(){"html5"===b.uploader.runtime&&a(".zlux-upload-dropzone-msg",b.dropzone).html(b.sprintf(b._("DROP_FILES"),"zlux-upload-browse")).on("click","a",function(){return b.options.browse_button.trigger("click"),!1}),b.inited=!0})})},initFilelist:function(){var b=this;b.filelist=a('<table cellpadding="0" cellspacing="0" border="0" class="zlux-upload-filelist table table-striped table-bordered"><tbody /></table>').appendTo(b.upload).on("click",".zlux-x-remove",function(){if("uploding"!==a(this).closest(".zlux-object").data("zlux-status")){var c=a(this).closest(".zlux-object"),d=b.uploader.getFile(c[0].id);d&&("undefined"===d||d.zlux_status!==plupload.STARTED&&d.status!==plupload.UPLOADING)?(b.uploader.removeFile(d),c.remove()):(c.remove(),b._updateFilelist())}})},initPlupload:function(){var b=this,c={runtimes:"html5, flash",browse_button:b.options.browse_button[0],drop_element:b.dropzone[0],max_file_size:d,url:a.zlux.url.ajax("zlux","upload"),filters:[{title:"Files",extensions:b.options.extensions}],flash_swf_url:a.zlux.url.zlfw("zlux/assets/plupload/Moxie.swf")};"s3"===b.options.storage&&a.extend(c,{url:"http://"+b.options.storage_params.bucket+".s3.amazonaws.com",multipart:!0,multipart_params:{key:"${filename}",Filename:"${filename}",acl:"public-read",success_action_status:"201",AWSAccessKeyId:b.options.storage_params.accesskey,policy:b.options.storage_params.policy,signature:b.options.storage_params.signature},file_data_name:"file"}),a.isEmptyObject(b.options.resize)||""===b.options.resize.width&&""===b.options.resize.height||a.extend(c,{resize:{width:b.options.resize.width,height:b.options.resize.height,crop:"1"==b.options.resize.crop?!0:!1}}),a.extend(c,{init:{BeforeUpload:function(a,c){b.eventBeforeUpload(c)},UploadFile:function(a,c){b.eventUploadFile(c)},UploadProgress:function(a,c){b.eventUploadProgress(c)},FileUploaded:function(a,c,d){b.eventFileUploaded(c,d)},UploadComplete:function(a,c){b.eventUploadComplete(c)},CancelUpload:function(){b.eventCancelUpload()},FilesAdded:function(a,c){b.eventFilesAdded(c)},QueueChanged:function(){b.eventQueueChanged()},StateChanged:function(){b.eventStateChanged()},Error:function(a,c){b.eventError(c)}}}),b.uploader=new plupload.Uploader(c),b.uploader.bind("Init",function(){b.trigger("Init")}),b.uploader.init()},eventError:function(b){var c,d,e=this,f=b.file;if(f){if(c="<strong>"+b.message+"</strong>",d=b.details)c+=" <br /><i>"+b.details+"</i>";else{switch(b.code){case plupload.FILE_EXTENSION_ERROR:d=e._("FILE_EXT_ERROR").replace("%s",f.name);break;case plupload.IMAGE_MEMORY_ERROR:d=e._("RUNTIME_MEMORY_ERROR");break;case plupload.HTTP_ERROR:d=e._("s3"===e.options.storage?e.options.storage_params.bucket.match(/\./g)?"S3_BUCKET_PERIOD_ERROR":"S3_BUCKET_MISSCONFIG_ERROR":"UPLOAD_URL_ERROR")}c+=" <br /><i>"+d+"</i>"}var g={name:f.name,basename:f.name.replace(/(\.[a-z0-9]+)$/,""),type:"file",content_type:f.type,size:{size:f.size,display:plupload.formatSize(f.size)}};g.dom=a("#"+f.id,e.filelist),e.trigger("FileError",g,c)}},eventStateChanged:function(){var a=this;a.uploader.state===plupload.UPLOADING&&a.upload.attr("data-zlux-status","uploading"),a.uploader.state===plupload.STOPPED&&(a.upload.attr("data-zlux-status","stopped"),a._updateFilelist())},eventBeforeUpload:function(b){var c=this,d=a("#"+b.id,c.filelist);if("local"===c.options.storage&&(c.uploader.settings.url=c.uploader.settings.url+"&path="+c.options.path),"s3"===c.options.storage){var e=c.options.path?c.options.path+"/":"";c.uploader.settings.multipart_params.key=e+b.name}a(".zlux-upload-file-progress",d).html("0%"),b.zlux_status=2,c._handleFileStatus(b),a(".zlux-upload-file-btn-remove",d).removeClass("icon-remove").addClass("icon-spinner icon-spin"),c.trigger("BeforeUpload",b)},eventUploadFile:function(b){var c=this,d={name:b.name,basename:b.name.replace(/(\.[a-z0-9]+)$/,""),type:"file",content_type:b.type,size:{size:b.size,display:plupload.formatSize(b.size)}};d.dom=a("#"+b.id,c.filelist),c.uploading=a.Deferred().fail(function(a){c.trigger("FileNotUpload",d,a)}).done(function(a){d.name=a,c.trigger("FileUploaded",d)}).always(function(){c._handleFileStatus(b)})},eventUploadProgress:function(b){var c=this,d=isNaN(b.percent)?0:b.percent;a("#"+b.id+" .zlux-upload-file-progress",c.filelist).html(d+"%"),c._handleFileStatus(b)},eventFileUploaded:function(b,c){var d,e=this;"local"===e.options.storage?(d=a.parseJSON(c.response),d.error?e.uploading.reject(d.error.message):e.uploading.resolve(d.result)):"s3"===e.options.storage&&(d=a(c.response),e.uploading.resolve(d.find("Key").html()))},eventUploadComplete:function(a){var b=this;b.trigger("UploadComplete",a)},eventCancelUpload:function(){var a=this;a.trigger("CancelUpload")},eventFilesAdded:function(a){var b=this;b.trigger("FilesAdded",a)},eventQueueChanged:function(){var a=this;a._updateFilelist()},getQueuedFiles:function(){var b=this,c=[];return a.each(b.uploader.files,function(a,b){b.status!==plupload.DONE&&"validating"!==b.status&&c.push(b)}),c},emptyQueue:function(){var a=this;a.uploader.splice(),a.filelist.empty()},_updateFilelist:function(){var b=this,c=!1,d=a(".zlux-object",b.filelist);a.each(b.uploader.files,function(a,d){d.status!==plupload.DONE&&"validating"!==d.status&&(c=!0),d.status===plupload.STOPPED&&b._handleFileStatus(d)}),(b.uploader.files.length||d.length)&&a(".zlux-upload-dropzone-msg",b.upload).hide(),b.uploader.files.length||d.length?c?b.upload.attr("data-zlux-status","queued"):b.upload.attr("data-zlux-status","stopped"):(b.upload.attr("data-zlux-status",""),a(".zlux-upload-dropzone-msg",b.upload).fadeIn()),b.trigger("QueueChanged",b.uploader.files)},_handleFileStatus:function(b){var c=this,d=a("#"+b.id,c.filelist),e="";b.zlux_status===plupload.STARTED?(e="started",b.zlux_status=""):(b.status===plupload.DONE&&(e="done"),b.status===plupload.FAILED&&(e="failed"),b.status===plupload.QUEUED&&(e="queued"),b.status===plupload.UPLOADING&&(e="uploading"),b.status===plupload.STOPPED&&a(".zlux-upload-file-progress",d).html("")),d.attr("data-zlux-status",e)},initDnDevents:function(){var c=this,d=a(),e=a(),f=!1,g=!1;a(b).on("drop",function(a){return a.preventDefault(),!1}).on("dragenter",function(a){0===d.size()&&(c.trigger("WindowDragHoverStart"),f=!0,g=!1),d=d.add(a.target)}).on("dragleave drop",function(b){setTimeout(function(){var c=!1;try{c=a("body").find(b.relatedTarget).length?!0:c}catch(e){}d=d.not(b.target),0!==d.size()||c||(f=!1)},1),setTimeout(function(){f||g||(c.trigger("WindowDragHoverEnd"),e=a(),d=a())},2)}),c.dropzone.on("dragenter",function(a){0===e.size()&&(c.trigger("WindowDragHoverStart"),f=!1,g=!0),e=e.add(a.target)}),c.dropzone.on("dragleave drop",function(b){setTimeout(function(){var c=!1;try{c=a("body").find(b.relatedTarget).length?!0:c}catch(d){}e=e.not(b.target),0!==e.size()||c||(g=!1)},1),setTimeout(function(){f||g||(c.trigger("WindowDragHoverEnd"),e=a(),d=a())},2)})}}),a.zlux[e.prototype.name]=function(){var a=arguments;return new e(a[0]?a[0]:{})}}(jQuery,window,document),function(a,b,c,d){"use strict";var e=function(b){this.options=a.extend({},this.options,b),this.events={}};a.extend(e.prototype,a.zlux.Main.prototype,{name:"filesPreview",renderPreviewDOM:function(b,c){var e,f=[];c=c===d?!1:c,b.size=b.size===d?!1:b.size,f.push({name:"name",value:b.basename}),"folder"===b.type?e='<span class="zlux-x-folder"></span>':(e=c?'<div class="zlux-x-image"><img src="'+a.zlux.url.root(b.path)+'" /></div>':'<span class="zlux-x-filetype">'+b.ext+"</span>",b.size&&f.push({name:"size",value:b.size.display}));var g="";return a.each(f,function(a,b){g+="<li>"+b.value+"</li>"}),a('<div class="zlux-preview"><div class="zlux-x-thumbnail">'+e+'</div><ul class="zlux-x-details unstyled">'+g+"</ul></div>")}}),a.zlux[e.prototype.name]=function(){var a=arguments;return new e(a[0]?a[0]:{})}}(jQuery,window,document);