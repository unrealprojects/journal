/* ===================================================
 * ZL Framework
 * https://zoolanders.com/extensions/zl-framework
 * ===================================================
 * Copyright (C) JOOlanders SL
 * http://www.gnu.org/licenses/gpl-2.0.html GNU/GPLv2 only
 * ========================================================== */
!function(a){"use strict";var b=function(b,c){var d=this;d.options=a.extend({},this.options,c),d.events={};var e=d.options.field;e="fields"+e.charAt(0).toUpperCase()+e.slice(1)+"Field",delete d.options.field,a(b).zlux(e,d.options)};a.zlux.fields=b}(jQuery,window,document),function(a){"use strict";var b=function(c,d){var e=this,f=a(c);f.data(b.prototype.name)||(e.element=a(c),e.options=a.extend({},b.prototype.options,d),this.events={},e.initialize(),e.element.data(b.prototype.name,e))};a.extend(b.prototype,a.zlux.Main.prototype,{name:"fieldsOptionsField",options:{},initialize:function(){var b=this;b.list=a("ul",b.element),b.hidden=a("li.hidden",b.list).detach(),b.element.addClass("zl-bootstrap"),b.element.on("click",".zlux-x-delete",function(){return a(this).closest("li").slideUp(400,function(){a(this).remove(),b.orderOptions()}),!1}).on("click",".zlux-x-add",function(){b.hidden.clone().removeClass("hidden").appendTo(b.list).slideDown(200).effect("highlight",{},1e3).find("input:first").focus(),b.orderOptions()}).on("blur",".zlux-x-name input",function(){var c=a(this).closest("li"),d=c.find(".panel input:text");if(""!==a(this).val()&&""===d.val()){var e="";b.getAlias(a(this).val(),function(a){e=a?a:"42",d.val(e),c.find("a.trigger").text(e)})}}).on("keydown",".panel input:text",function(c){c.stopPropagation(),13===c.which&&b.setOptionValue(a(this).closest("li")),27===c.which&&b.removeOptionPanel(a(this).closest("li"))}).on("click","input.accept",function(){return b.setOptionValue(a(this).closest("li")),!1}).on("click","a.cancel",function(){return b.removeOptionPanel(a(this).closest("li")),!1}).on("click","a.trigger",function(){return a(this).hide().closest("li").find("div.panel").addClass("active").find("input:text").focus(),!1}),this.list.sortable({handle:".zlux-x-sort",containment:this.list.parent().parent(),placeholder:"dragging",axis:"y",opacity:1,revert:75,delay:100,tolerance:"pointer",zIndex:99,start:function(a,c){c.placeholder.height(c.helper.height()),b.list.sortable("refreshPositions")},stop:function(){b.orderOptions()}})},setOptionValue:function(a){var b=this,c=a.find("div.panel input:text"),d=c.val();""===d&&(d=a.find("div.zlux-x-name input").val()),this.getAlias(d,function(e){d=e?e:"42",c.val(d),a.find("a.trigger").text(d),b.removeOptionPanel(a)})},orderOptions:function(){var b=this,c=/(elements\[\S+])\[(-?\d+)\]/g;b.list.children("li").each(function(b){a(this).find("input").each(function(){a(this).attr("name")&&a(this).attr("name",a(this).attr("name").replace(c,"$1["+b+"]"))})})},getAlias:function(b,c){var d=a.zlux.url.ajax("manager","getalias",{force_safe:1});a.getJSON(d,{name:b},function(a){c(a)})},removeOptionPanel:function(a){a.find("div.panel input:text").val(a.find("a.trigger").show().text()),a.find("div.panel").removeClass("active")}}),a.zlux[b.prototype.name]=b}(jQuery,window,document),function(a){"use strict";var b=function(c,d){var e=this,f=a(c);f.data(b.prototype.name)||(e.element=a(c),e.options=a.extend({},b.prototype.options,d),this.events={},e.initialize(),e.element.data(b.prototype.name,e))};a.extend(b.prototype,a.zlux.Main.prototype,{name:"fieldsAttributesField",options:{},initialize:function(){var b=this;b.hidden=a(".hidden",b.element).detach(),b.list=a("ul.zlux-field-attributes",b.element),b.element.addClass("zl-bootstrap"),b.element.on("click",".zlux-x-delete",function(){return a(this).closest("li").slideUp(400,function(){a(this).remove(),b.updateIndexes(a(this).closest("ul"))}),!1}).on("click",".zlux-x-add-attr",function(){var c=a(this).siblings("ul"),d=b.hidden.find("li.zlux-x-attr").clone().removeClass("hidden");d.appendTo(c).slideDown(200).effect("highlight",{},1e3).find("input:first").focus(),b.updateIndexes()}).on("click",".zlux-x-add",function(){var c=a(this).siblings("ul"),d=b.hidden.find("li.zlux-x-option").clone().removeClass("hidden");d.appendTo(c).slideDown(200).effect("highlight",{},1e3).find("input:first").focus(),b.updateIndexes()}).on("blur",".zlux-x-name input",function(){var c=a(this).closest("li"),d=c.find(".panel input:text");if(""!==a(this).val()&&""===d.val()){var e="";b.getAlias(a(this).val(),function(a){e=a?a:"42",d.val(e),c.find("a.trigger").text(e)})}}).on("keydown",".panel input:text",function(c){c.stopPropagation(),13===c.which&&b.setOptionValue(a(this).closest("li")),27===c.which&&b.removeOptionPanel(a(this).closest("li"))}).on("click","input.accept",function(){return b.setOptionValue(a(this).closest("li")),!1}).on("click","a.cancel",function(){return b.removeOptionPanel(a(this).closest("li")),!1}).on("click","a.trigger",function(){return a(this).hide().closest("li").find("div.panel").addClass("active").find("input:text").focus(),!1}),a("ul",b.element).each(function(){b.initList(a(this))})},initList:function(b){var c=this;b.sortable({handle:".zlux-x-sort",containment:b.parent().parent(),placeholder:"dragging",axis:"y",opacity:1,revert:75,delay:100,tolerance:"pointer",zIndex:99,start:function(c,d){d.placeholder.height(40),b.sortable("refreshPositions"),b.children("li").find("ul").addClass("hidden"),a(d.item).height("")},stop:function(){c.updateIndexes(),b.children("li").find("ul").removeClass("hidden")}})},setOptionValue:function(a){var b=this,c=a.find("div.panel input:text"),d=c.val();""===d&&(d=a.find("div.zlux-x-name input").val()),this.getAlias(d,function(e){d=e?e:"42",c.val(d),a.find("a.trigger").text(d),b.removeOptionPanel(a)})},updateIndexes:function(){var b=this,c=/(elements\[\w{8}-\w{4}-\w{4}-\w{4}-\w{12}\]\[\S+?\])\[(\d+)\]/g,d=/(elements\[\w{8}-\w{4}-\w{4}-\w{4}-\w{12}\]\[\S+\])\[(\d+)\]/g;b.list.children("li").each(function(b){a("input",a(this)).each(function(){a(this).attr("name")&&a(this).attr("name",a(this).attr("name").replace(c,"$1["+b+"]"))}),a("ul",a(this)).children("li").each(function(b){a("input",a(this)).each(function(){a(this).attr("name")&&a(this).attr("name",a(this).attr("name").replace(d,"$1["+b+"]"))})})})},getAlias:function(b,c){var d=a.zlux.url.ajax("manager","getalias",{force_safe:1});a.getJSON(d,{name:b},function(a){c(a)})},removeOptionPanel:function(a){a.find("div.panel input:text").val(a.find("a.trigger").show().text()),a.find("div.panel").removeClass("active")}}),a.zlux[b.prototype.name]=b}(jQuery,window,document),function(a){"use strict";var b=function(c,d){var e=this,f=a(c);f.data(b.prototype.name)||(e.element=a(c),e.options=a.extend({},b.prototype.options,d),this.events={},e.initialize(),e.element.data(b.prototype.name,e))};a.extend(b.prototype,a.zlux.Main.prototype,{name:"fieldsItemsField",options:{controlName:""},initialize:function(){var b=this;b.aRelated=[],b.list=a("<ul />").addClass("zlux-field-items").appendTo(b.element).sortable({handle:".zlux-x-sort",placeholder:"dragging",axis:"y",opacity:1,delay:100,tolerance:"pointer",containment:"parent",forcePlaceholderSize:!0,scroll:!1,start:function(a,b){b.helper.addClass("ghost")},stop:function(a,b){b.item.removeClass("ghost")}}).on("click",".zlux-x-delete",function(){a(this).closest("li").fadeOut(200,function(){var c={};c.id=a(this).data("id"),b.removeRelation(c)})}),a(".zlux-x-item",b.element).each(function(c,d){var e=a(d).data("info");b.appendRelation(e),a(d).remove()}),b.element.addClass("zl-bootstrap"),b.dialogTrigger=a('<button type="button" class="btn btn-mini"><i class="icon-plus-sign"></i> Add item </button>').appendTo(b.element),a.zlux.assets.load("items").done(function(){b.dialogTrigger.zlux("itemsDialogManager",{position:{of:b.element,my:"left top",at:"right top"},apps:b.options.apps,types:b.options.types}).on("zlux.ObjectSelected",function(c,d,e){"-1"!=a.inArray(e.id,b.aRelated)?b.removeRelation(e):(a(".column-icon i",e.dom).removeClass("icon-file-alt").addClass("icon-check"),b.appendRelation(e))}).on("zlux.TableDrawCallback",function(c,d){a("tbody tr",d.oTable).each(function(c,d){"-1"!=a.inArray(d.getAttribute("data-id"),b.aRelated)&&a(".column-icon i",d).removeClass("icon-file-alt").addClass("icon-check")}),b.manager=d})})},appendRelation:function(b){var c=this;a('<li class="zlux-x-item" data-id="'+b.id+'"><div class="zlux-x-name">'+b.name+'</div><span class="zlux-x-tools"><i class="zlux-x-delete icon-remove-circle" title="Delete"></i><i class="zlux-x-sort icon-move" title="Sort"></i></span><div class="zlux-x-info"><div>'+b.type.name+" / "+b.application.name+'</div></div><input type="hidden" name="'+c.options.controlName+'" value="'+b.id+'"/></li>').appendTo(c.list),c.aRelated.push(b.id)},removeRelation:function(b){var c=this;a('li[data-id="'+b.id+'"]',c.list).remove(),c.aRelated.splice(a.inArray(b.id,c.aRelated),1),c.manager&&a('tbody tr[data-id="'+b.id+'"] .column-icon i',c.manager.oTable).removeClass("icon-check").addClass("icon-file-alt")}}),a.zlux[b.prototype.name]=b}(jQuery,window,document);