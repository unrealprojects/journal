/* ===================================================
 * ZL Framework
 * https://zoolanders.com/extensions/zl-framework
 * ===================================================
 * Copyright (C) JOOlanders SL
 * http://www.gnu.org/licenses/gpl-2.0.html GNU/GPLv2 only
 * ========================================================== */
!function(a){var b=function(){};b.prototype=a.extend(b.prototype,{name:"ZLfield",options:{url:"",type:"",enviroment:"",enviroment_args:""},initialize:function(b,c){this.options=a.extend({},this.options,c);var d=this;a("#toolbar-apply, #toolbar-save").click(function(){return a(".zlfield input").each(function(){a(this).val()||a(this).remove()}),!0}),a(document).ready(function(){a(".zlfield-main .chzn-container").each(function(){a(this).prev("select").data("chosen",null).show(),a(this).remove()}),a(".col-left ul.element-list").on("element.added",function(b,c){d.actions(a(c))}),a("ul.ui-sortable").on("sortstop",function(b,c){var e=RegExp(/(elements\[[a-z0-9_-]+\])|(positions\[[a-z0-9_-]+\]\[[0-9]+\])/);a("#assign-elements ul.element-list:not(.unassigned)").each(function(){var b="positions["+a(this).data("position")+"]";a(this).children().each(function(c){a(this).find("[data-control^=positions], [data-control^=elements]").each(function(){a(this).attr("data-control","tmp"+a(this).attr("data-control").replace(e,b+"["+c+"]"))})})}),e=RegExp(/^tmp/),a("#assign-elements ul.element-list").find("[data-control^=tmp]").each(function(){a(this).attr("data-control",a(this).attr("data-control").replace(e,""))}),d.actions(c.item)}),d.initActions()})},initActions:function(){var b=this,c=b.options.enviroment;("type-positions"==c||"type-edit"==c)&&a(".col-left ul.ui-sortable > li.element").each(function(){a(this).parent().trigger("sortstop",{item:a(this)})}),"type-edit"==c&&a(".col-left .core-element-configuration .element-list > li.element").each(function(){b.actions(a(this))}),"item-edit"==c&&a(".item-edit .creation-form .zlfield-main").each(function(){b.actions(a(this))}),"module"==c&&a("form#module-form .zlfield-main").each(function(){a(this).closest("li, .control-group").addClass("zlfield-module"),a(this).closest(".controls").removeClass("controls"),b.actions(a(this))}),"app-config"==c&&a(".col-right .zlfield-main").each(function(){b.actions(a(this))})},actions:function(b){var c=this;b.data("zlfield-actions-init")||(b.find(".qTipHelp").each(function(){var b=a(this);b.qtip({overwrite:!1,content:{text:b.find(".qtip-content")},position:{my:"bottom center",at:"top center",viewport:a(window)},show:{solo:!0,delay:300},hide:{fixed:!0,delay:300},style:"ui-tooltip-light ui-tooltip-zlparam"})}),b.find(".zl-select-expand").each(function(){var b=a(this);b.click(function(){a(this).prev().height(150),a(this).remove()}).qtip({overwrite:!1,content:{text:b.data("zl-qtip")},position:{at:"right top",my:"left bottom"},show:{solo:!0,delay:600},hide:{delay:0},style:"ui-tooltip-light ui-tooltip-zlparam"})}),a("#toolbar-apply, #toolbar-save").on("mousedown",function(){b.find(".zl-row[data-type=password] .zl-field input").each(function(){a(this).val("zl-decrypted["+a(this).val()+"]")})}),b.find(".zl-state").each(function(){var b=a(this).find("input"),c=b.closest(".zl-row");b.on("change",function(){var b="checked"==a(this).attr("checked");b?(c.removeClass("zl-disabled"),c.find(".zl-field").children().removeAttr("disabled")):(c.addClass("zl-disabled"),c.find(".zl-field").children().attr("disabled",!0))}).trigger("change")}),b.find(".zl-state input").each(function(){var b=a(this);b.qtip({content:{text:"Override this field"},position:{at:"left top",my:"right bottom",effect:!1},show:{target:b.closest(".zl-row"),solo:!0,delay:200},hide:{target:b.closest(".zl-row"),delay:0},style:"ui-tooltip-light ui-tooltip-zlparam",events:{show:function(a,c){"checked"==b.attr("checked")&&a.preventDefault(),b.bind("change",function(){c.hide()}),c.set("content.text",b.parent().attr("tooltip"))}}})}),b.find(".zl-toggle").each(function(){var b=a(this),c=b.next();a(".btn-open",b).on("click",function(){b.toggleClass("open")&&c.show()}),a(".btn-close",b).on("click",function(){b.toggleClass("open")&&c.hide()})}),b.find("[data-dependents]").each(function(){var b=a(this),c=b.data("dependents").replace(/ /g,"").split("|"),f=b.closest(".zlfield.placeholder .wrapper, .zlfield.placeholder").first();c.each(function(c){var g=c.split("!>"),h=2==g.length?"!>":">";g=">"==h?c.split(">"):g,d=g[0].split(","),e=g[1].replace("NONE",""),("select"==b.data("type")||"itemLayoutList"==b.data("type")||"layout"==b.data("type")||"apps"==b.data("type")||"types"==b.data("type")||"elements"==b.data("type")||"modulelist"==b.data("type")||"separatedby"==b.data("type"))&&d.each(function(c){var d=f.find('[data-id="'+c+'"]').data("e",e).data("m",h).hide();b.find(".zl-field select").bind("change",function(){var b=d.data("e"),c=d.data("m"),e=a.makeArray(a(this).val()),f=0;if(b&&b.match(/OR/g))a.each(e,function(a,d){var e=new RegExp("(\\b|OR)"+d+"(\\b|OR)","g");("!>"==c&&!b.match(e)||">"==c&&b.match(e))&&(f=1)});else if(b&&b.match(/AND/g)){var g=b.split("AND").length;e.length==g&&a.each(e,function(a,d){var e=new RegExp("(\\b|AND)"+d+"(\\b|AND)","g");f="!>"==c&&!b.match(e)||">"==c&&b.match(e)?1:0})}else a.each(e,function(a,d){("!>"==c&&d!=b||">"==c&&d==b)&&(f=1)});f&&d.slideDown("fast")||d.slideUp("fast")}).trigger("change")}),"checkbox"==b.data("type")&&d.each(function(c){var d=f.find('[data-id="'+c+'"]').hide();b.find(".zl-field input").bind("change",function(){var b="checked"==a(this).attr("checked");("!>"==h&&!b||">"==h&&b)&&d.slideDown("fast")||d.slideUp("fast")}).trigger("change")}),"radio"==b.data("type")&&d.each(function(c){var d=e,g=f.find('[data-id="'+c+'"]').hide();b.find(".zl-field input").bind("change",function(){var b="checked"==a(this).attr("checked"),c=0,e=a(this).attr("value");if(b){if(d&&d.match(/OR/g)){var f=new RegExp(e,"g");("!>"==h&&!d.match(f)||">"==h&&d.match(f))&&(c=1)}else("!>"==h&&e!=d&&b||">"==h&&e==d&&b&&b)&&(c=1);c&&g.slideDown("fast")||g.slideUp("fast")}}).trigger("change")}),"text"==b.data("type")&&d.each(function(c){var d=f.find('[data-id="'+c+'"]').hide();b.find(".zl-field input").on("keyup change",function(){var b=""!=a(this).val();("!>"==h&&!b||">"==h&&b)&&d.slideDown("fast")||d.slideUp("fast")}).trigger("change")})})}),b.find("[data-dependent]").each(function(){var b=a(this).hide(),d=b.data("dependent").replace(/ /g,""),e=d.match(/AND/g)?d.split("AND"):[],f=d.match(/OR/g)?d.split("OR"):[],g=b.parents(".zlfield.placeholder .wrapper, .zlfield.placeholder").first();b.on("zlfield-dependent-event",function(){A_match=0,A_match=e.length?c.evaluateDependentRules(e,b,g,"AND"):c.evaluateDependentRules(f,b,g,"OR"),A_match&&b.slideDown("fast")||b.slideUp("fast")}).trigger("zlfield-dependent-event")}),b.find("[data-relieson]").each(function(){var b=a(this),d=b.data("relieson"),e=b.parents(".placeholder").find('[data-id="'+d.id+'"]'),f=e.find("select");f.on("change",function(){var e=a(this).val()?a(this).val():"",g=a(this).closest(".zl-field"),h=d.json,i=b.attr("data-control"),j=a(this).closest(".zlfield-main").attr("data-ajaxargs"),k=d.psv,l=d.id;k[d.id]=e,g.append(a('<span class="activity zl-loader">'));a.ajax({type:"POST",url:d.url+"&task=loadfield",data:{json:h,ctrl:i,psv:k,pid:l,node:null,args:j,ajaxcall:!0,enviroment:c.options.enviroment,enviroment_args:c.options.enviroment_args}}).done(function(d){d=a.parseJSON(d),g.find(".activity").remove(),b.slideUp("fast",function(){b.empty(),d&&d.result&&b.html('<div class="loaded-fields">'+d.result+"</div>"),c.actions(b.find("> .loaded-fields")),b.slideDown("fast"),f.trigger("loaded.zlfield")})})})}),b.find(".load-field-btn").on("click",function(b){b.preventDefault();var d=a(this),e=d.parent(".zlfield-main"),f=e.data("ajaxargs");d.find("span").addClass("zlux-loader-raw"),a.ajax({url:c.options.url,type:"POST",data:{task:"loadZLfield",group:f.group,type:c.options.type,control_name:f.control_name,json_path:f.json_path,element_id:f.element_id,element_type:f.element_type,enviroment:f.enviroment,node:f.node},success:function(b){b=a.parseJSON(b),e.fadeOut("fast",function(){a(this).html(b.result),c.actions(e),e.fadeIn("slow")})}})}),a("[data-type=items] .zl-field",b).each(function(){var b=a(this),c=a("input.zlux-x-dummy",b),d=c.val(),e=c.data("params");c.remove(),a.zlux.assets.load("fields").done(function(){b.zlux("fields",a.extend({},e,{field:"items",controlName:d}))})}),a("[data-type=options] .zl-field",b).each(function(){var b=a(this),c=a("input.zlux-x-dummy",b),d=c.val(),e=c.data("params");c.remove(),a.zlux.assets.load("fields").done(function(){b.zlux("fields",a.extend({},e,{field:"options",controlName:d}))})}),a("[data-type=attributes] .zl-field",b).each(function(){var b=a(this),c=a("input.zlux-x-dummy",b),d=c.val(),e=c.data("params");c.remove(),a.zlux.assets.load("fields").done(function(){b.zlux("fields",a.extend({},e,{field:"attributes",controlName:d}))})}),b.data("zlfield-actions-init",!0))},evaluateDependentRules:function(b,c,d,f){var g=0,h=1;return b.each(function(b){if(!h)return!1;var i=b.split("!="),j=2==i.length?"!=":"==";if(i="=="==j?b.split("=="):i,field=d.find('[data-id="'+i[0]+'"]'),type=field.data("type"),unique_id=f+"-"+c.data("id")+"-"+field.data("id")+"-"+d.data("id"),e=i[1].replace("NONE",""),"select"==type||"itemLayoutList"==type||"layout"==type||"apps"==type||"types"==type||"elements"==type||"modulelist"==type||"separatedby"==type){var k=field.find(".zl-field select"),l=a.makeArray(k.val()),m=0;if(e&&e.match(/OR/g))a.each(l,function(a,b){var c=new RegExp("(\\b|OR)"+b+"(\\b|OR)","g");("!="==j&&!e.match(c)||"=="==j&&e.match(c))&&(m=1)});else if(e&&e.match(/AND/g)){var n=e.split("AND").length;l.length==n&&a.each(l,function(a,b){var c=new RegExp("(\\b|AND)"+b+"(\\b|AND)","g");m="!="==j&&!e.match(c)||"=="==j&&e.match(c)?1:0})}else a.each(l,function(a,b){("!="==j&&b!=e||"=="==j&&b==e)&&(m=1)});g=m,k.data("zlfield-dependent-"+unique_id+"-init")||(k.on("change",function(){c.trigger("zlfield-dependent-event")}),k.data("zlfield-dependent-"+unique_id+"-init",!0))}if("checkbox"==type){var o=field.find(".zl-field input"),m=0,p="checked"==o.attr("checked");("!="==j&&!p||"=="==j&&p)&&(m=1),g=m,o.data("zlfield-dependent-"+unique_id+"-init")||(o.on("change",function(){c.trigger("zlfield-dependent-event")}),o.data("zlfield-dependent-"+unique_id+"-init",!0))}if("radio"==type){var q=field.find(".zl-field input"),m=0,r=e;q.each(function(){var b="checked"==a(this).attr("checked"),c=a(this).attr("value");if(b)if(r&&r.match(/OR/g)){var d=new RegExp(c,"g");("!="==j&&!r.match(d)||"=="==j&&r.match(d))&&(m=1)}else("!="==j&&c!=r&&b||"=="==j&&c==r&&b&&b)&&(m=1)}),g=m,q.data("zlfield-dependent-"+unique_id+"-init")||(q.on("change",function(){c.trigger("zlfield-dependent-event")}),q.data("zlfield-dependent-"+unique_id+"-init",!0))}if("text"==type){var s=field.find(".zl-field input"),t=""!=s.val();("!="==j&&!t||"=="==j&&t)&&(m=1),g=m,s.data("zlfield-dependent-"+unique_id+"-init")||(s.on("keyup change",function(){c.trigger("zlfield-dependent-event")}),s.data("zlfield-dependent-"+unique_id+"-init",!0))}("AND"==f&&!g||"OR"==f&&g)&&(h=!1)}),g}}),a.fn[b.prototype.name]=function(){var c=arguments,d=c[0]?c[0]:null;return this.each(function(){var e=a(this);if(b.prototype[d]&&e.data(b.prototype.name)&&"initialize"!=d)e.data(b.prototype.name)[d].apply(e.data(b.prototype.name),Array.prototype.slice.call(c,1));else if(!d||a.isPlainObject(d)){var f=new b;b.prototype.initialize&&f.initialize.apply(f,a.merge([e],c)),e.data(b.prototype.name,f)}else a.error("Method "+d+" does not exist on jQuery."+b.name)})}}(jQuery);