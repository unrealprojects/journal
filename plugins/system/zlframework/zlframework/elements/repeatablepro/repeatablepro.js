/* ===================================================
 * ZL Framework
 * https://zoolanders.com/extensions/zl-framework
 * ===================================================
 * Copyright (C) JOOlanders SL
 * http://www.gnu.org/licenses/gpl-2.0.html GNU/GPLv2 only
 * ========================================================== */
!function(a){var b=function(){};a.extend(b.prototype,{name:"ElementRepeatablePro",options:{msgDeleteElement:"Delete Element",msgSortElement:"Sort Element",msgLimitReached:"Limit reached",instanceLimit:"",url:""},initialize:function(b,c){this.options=a.extend({},this.options,c);var d=this,e=a("ul.repeatable-list",b),f=a("li.hidden",e).remove(),g=e.children("li.repeatable-element").length;d.element=b,d.list=e,d.count=g,d.options.msgAddInstance=a("p.add a",b).html(),e.children("li.repeatable-element").each(function(){a(this).children().wrapAll(a("<div>").addClass("repeatable-content")),d.attachButtons(a(this))}),e.on("mousedown",".zlux-x-sort",function(){a(".more-options.show-advanced",e).removeClass("show-advanced"),e.height(e.height()),a(this).closest("li.repeatable-element").find(".more-options").hide().end().find(".file-details").hide()}).on("mouseup",".zlux-x-sort",function(){a(this).closest("li.repeatable-element").find(".more-options").show().end().find(".file-details").show()}).on("click",".zlux-x-delete",function(){var c=a(this).closest("li.repeatable-element");c.fadeOut(200,function(){a(this).remove(),b.trigger("instance.deleted",[c]),d.options.instanceLimit&&a("p.add a",b).removeClass("disabled").html(d.options.msgAddInstance)})}).sortable({handle:".zlux-x-sort",placeholder:"repeatable-element dragging",axis:"y",opacity:1,delay:100,cursorAt:{top:16},tolerance:"pointer",containment:"parent",scroll:!1,start:function(b,c){c.item.addClass("ghost"),c.placeholder.height(c.item.height()-2),c.placeholder.width(a("div.repeatable-content",c.item).width()-2)},stop:function(b,c){c.item.removeClass("ghost"),a(".more-options",c.item).show(),a(".file-details",c.item).show(),e.height(""),d.updateIndexes(a(b.target))}}),a("p.add a",b).on("click",function(){return d.options.instanceLimit&&d.options.instanceLimit<=e.children().length?!1:(d.addElementInstance(f.html()),void(d.options.instanceLimit&&d.options.instanceLimit<=e.children().length&&a("p.add a",b).addClass("disabled").html(d.options.msgLimitReached)))})},loadElementInstance:function(b,c){var d=this;a.ajax({url:d.options.ajax_url+"&task=callelement",type:"POST",data:{method:"getemptylayout",layout:b},success:function(a){d.addElementInstance(a),d.element.trigger("instance.added",[a,c])}})},addElementInstance:function(b){var c=this;if(c.list.hasClass("repeatable-list-level2")){var d=new RegExp(/(?:elements\[\w{8}-\w{4}-\w{4}-\w{4}-\w{12}\])\[(-?\d+)\]/),e=d.exec(a('[name^="elements"]',c.list).first().attr("name")).pop();b=b.replace(/(elements\[\w{8}-\w{4}-\w{4}-\w{4}-\w{12}\])(\[-?\d+\])/g,"$1["+e+"]"),b=b.replace(/(elements\[\S+])\[(-?\d+)\]/g,"$1["+c.count++ +"]")}else b=b.replace(/(elements\[\w{8}-\w{4}-\w{4}-\w{4}-\w{12}\])(\[-?\d+\])/g,"$1["+c.count++ +"]");b=b.replace(/\[zluxvar-1\]/g,c.count),b=a('<li class="repeatable-element"><div class="repeatable-content">'+b+"</div></li>"),c.attachButtons(b),a("input, textarea",b).filter(function(){return"hidden"!=a(this).attr("type")}).each(function(){a(this).val("").html("")}),b.appendTo(c.list),b.children("div.repeatable-content").effect("highlight",{},1e3)},attachButtons:function(b){a(".zlux-x-sort, .zlux-x-delete",b)[0]||(a("<span>").addClass("zlux-x-sort sort").attr("title",this.options.msgSortElement).appendTo(b),a("<span>").addClass("zlux-x-delete delete").attr("title",this.options.msgDeleteElement).appendTo(b))},updateIndexes:function(){var b=this;if(b.list.hasClass("repeatable-list-level2"))var c=new RegExp(/(elements\[\S+])\[(-?\d+)\]/);else var c=new RegExp(/(elements\[\w{8}-\w{4}-\w{4}-\w{4}-\w{12}\])(\[-?\d+\])/);b.list.children("li.repeatable-element").each(function(b){a('[name^="elements"]',a(this)).each(function(){var d=a(this).attr("name").replace(c,"$1["+b+"]");a(this).attr("name",d)})})}}),a.fn[b.prototype.name]=function(){var c=arguments,d=c[0]?c[0]:null;return this.each(function(){var e=a(this);if(b.prototype[d]&&e.data(b.prototype.name)&&"initialize"!=d)e.data(b.prototype.name)[d].apply(e.data(b.prototype.name),Array.prototype.slice.call(c,1));else if(!d||a.isPlainObject(d)){var f=new b;b.prototype.initialize&&f.initialize.apply(f,a.merge([e],c)),e.data(b.prototype.name,f)}else a.error("Method "+d+" does not exist on jQuery."+b.name)})}}(jQuery);